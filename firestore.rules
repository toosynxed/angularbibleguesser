rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- User Data ---
    // Users can read public profiles, but can only create and update their own document.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      // Allow users to update their own profile data (e.g., displayName, customization).
      allow update: if request.auth.uid == userId;
    }

    // --- Multiplayer Lobbies ---
    // Any authenticated user can read or create a lobby.
    match /lobbies/{lobbyId} {
      allow read, create: if request.auth != null;
      // The lobby owner can update any field.
      // Other players can only update game-state related fields.
      allow update: if request.auth.uid == resource.data.ownerId ||
                      request.resource.data.diff(resource.data).affectedKeys().hasAny([
                        'guesses', 'state', 'currentRound', 'lastUpdatedAt', 'players'
                      ]);
    }

    // Players can be added to a lobby, but not modified or deleted by clients.
    match /lobbies/{lobbyId}/players/{playerId} {
      allow read, create: if request.auth != null;
      allow update, delete: if false;
    }

    // --- Daily Challenges ---
    // Any authenticated user can read the daily challenges (for the calendar and playing).
    match /daily_challenges/{date} {
      allow read: if request.auth != null;
      allow write: if false; // Only backend/admins should create challenges
    }

    // --- Daily Scores (for Leaderboards) ---
    // Anyone can read scores for leaderboards.
    // Users can only create or update their own score entry.
    match /daily_scores/{date}/scores/{userId} {
       allow read: if request.auth != null;
       allow create, update: if request.auth != null && request.auth.uid == userId;
       allow delete: if false;
    }

    // --- Shared Games (for sharing results) ---
    // Any authenticated user can create a shared game link.
    // Anyone (even unauthenticated) can read a shared game to view the results.
    match /sharedGames/{shareId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if false;
    }
  }
}
