<div class="container">
  <div class="header-actions">
    <div class="stats-area" *ngIf="user$ | async as user">
      <button class="stats-button"
              [class.disabled]="user.isAnonymous"
              (click)="!user.isAnonymous && (showStats = true)"
              [title]="user.isAnonymous ? 'Login to view stats' : 'View your stats'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
        <span>Stats</span>
      </button>
      <button class="stats-button"
              (click)="showLeaderboard = true"
              title="View leaderboards">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 15h1.5a2.5 2.5 0 0 1 0 5H4"/><path d="M18 15h1.5a2.5 2.5 0 0 0 0 5H18"/><path d="M9 6h6"/><path d="M9 18h6"/><path d="M12 3v18"/></svg>
        <span>Leaderboards</span>
      </button>
    </div>
    <div class="login-area" *ngIf="user$ | async as user; else showLoginButton">
      <button class="login-button secondary-action" routerLink="/login">
        {{ user.isAnonymous ? 'Profile / Login' : 'Profile' }}
      </button>
      <div class="login-prompt" *ngIf="(user$ | async)?.isAnonymous">
        <span class="prompt-text">Login or create an account to save your name and progress!</span>
        <span class="arrow">⤴</span>
      </div>
    </div>
    <!-- Fallback for when user$ is null (still loading) -->
    <ng-template #showLoginButton>
      <div class="login-area">
        <button class="login-button secondary-action" routerLink="/login">Profile / Login</button>
      </div>
    </ng-template>
  </div>

  <header>
    <img src="assets/logo.png" alt="Better Bible Guesser • " class="logo">
    <p class="header-text" style="margin-bottom: 1rem;">Test your knowledge of the Holy Scripture.</p>
  </header>
  <main class="home-main" style="padding-top:0px;" *ngIf="!showCustomAndCodeMenu">
      <h2 style="margin-block-start: 0px; margin-block-end: 0px;">Choose a Game Mode</h2>
      <!-- Display error messages here -->
      <p *ngIf="error" class="error-message">{{ error }}</p>

      <button class="primary" (click)="startGame('normal')">Normal Mode</button>
      <button class="primary daily-button" routerLink="/daily">Daily Mode</button>
      <button class="primary" (click)="goToMultiplayer()">Online Multiplayer Mode</button>
      <button class="primary" (click)="showCustomAndCodeMenu = true">Custom & Upload Codes</button>
  </main>

  <main class="home-main" style="padding-top:0px;" *ngIf="showCustomAndCodeMenu">
      <h2 style="margin-block-start: 0px; margin-block-end: 0px;">Custom & Upload Modes</h2>

      <button class="primary" (click)="startGame('custom')">Custom Mode</button>
      <button class="primary" (click)="createGame()">Create Mode</button>
      <button class="secondary-action" (click)="showCodeInput = !showCodeInput">Upload Via Code</button>

      <div *ngIf="showCodeInput" class="code-input-container">
        <input type="text" [(ngModel)]="gameCode" placeholder="Enter game code..." (keyup.enter)="playFromCode()">
        <button class="secondary-action" (click)="playFromCode()">Start from Code</button>
      </div>
      <button class="secondary-action back-button" (click)="showCustomAndCodeMenu = false">‹ Back</button>
  </main>

  <!-- Admin Panel -->
  <div *ngIf="isAdmin$ | async">
    <app-admin-panel></app-admin-panel>
    <button (click)="resetDailyVerses()">Reset Daily Verses (Admin)</button>
  </div>

  <!-- Changelog Button -->
  <button class="changelog-button" (click)="showChangelog = true">Changelog</button>

  <!-- Help Button -->
  <button class="help-button" (click)="showHelp = true">?</button>

  <!-- Changelog Modal -->
  <div *ngIf="showChangelog" class="modal-backdrop" (click)="showChangelog = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Changelog</h2>
        <button class="close-button" (click)="showChangelog = false">&times;</button>
      </div>
      <div class="modal-body">
        <!-- The content below is rendered from the changelogContent property in your component -->
        <div class="changelog-content" [innerHTML]="changelogContent"></div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div *ngIf="showHelp" class="modal-backdrop" (click)="showHelp = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-tabs">
          <button class="tab-button" [class.active]="activeHelpTab === 'rules'" (click)="activeHelpTab = 'rules'">Rules</button>
          <button class="tab-button" [class.active]="activeHelpTab === 'about'" (click)="activeHelpTab = 'about'">About</button>
          <button class="tab-button" [class.active]="activeHelpTab === 'learn'" (click)="activeHelpTab = 'learn'">Learn</button>
        </div>
        <button class="close-button" (click)="showHelp = false">&times;</button>
      </div>
      <div class="modal-body">
        <div *ngIf="activeHelpTab === 'rules'" class="help-content" [innerHTML]="rulesContent">
          <!-- Rules content is displayed here -->
        </div>
        <div *ngIf="activeHelpTab === 'about'" class="help-content" [innerHTML]="aboutContent">
          <!-- About content is displayed here -->
        </div>
        <div *ngIf="activeHelpTab === 'learn'" class="help-content" [innerHTML]="learnMoreContent">
          <!-- Learn More content is displayed here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Modal -->
  <div *ngIf="showStats" class="modal-backdrop" (click)="showStats = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Your Stats</h2>
        <button class="close-button" (click)="showStats = false">&times;</button>
      </div>
      <div class="modal-body">
        <div *ngIf="stats$ | async as stats; else loadingOrNoStats">
          <div class="stats-container">

            <!-- Normal Mode Stats -->
            <div class="stat-card" *ngIf="stats.normal as normalStats">
              <h3>Normal Mode</h3>
              <p><strong>Games Played:</strong> {{ normalStats.gamesPlayed || 0 }}</p>
              <p><strong>Average Score:</strong> {{ getAverage(normalStats.totalScore, normalStats.gamesPlayed) }} / 100</p>
              <p><strong>Average Stars:</strong> {{ getAverage(normalStats.totalStars, normalStats.gamesPlayed) }} / 3</p>
            </div>

            <!-- Custom Mode Stats -->
            <div class="stat-card" *ngIf="stats.custom as customStats">
              <h3>Custom Mode</h3>
              <p><strong>Games Played:</strong> {{ customStats.gamesPlayed || 0 }}</p>
              <p><strong>Total Rounds Played:</strong> {{ customStats.totalRounds || 0 }}</p>
              <p><strong>Average Score/Round:</strong> {{ getAverage(customStats.totalScore, customStats.totalRounds) }}</p>
            </div>

            <!-- Multiplayer Mode Stats -->
            <div class="stat-card" *ngIf="stats.multiplayer as multiStats">
              <h3>Multiplayer Mode</h3>
              <p><strong>Games Played:</strong> {{ multiStats.gamesPlayed || 0 }}</p>
              <p><strong>Average Score/Round:</strong> {{ getAverage(multiStats.totalScore, multiStats.totalRounds) }}</p>
            </div>

            <!-- Daily Mode Stats -->
            <div class="stat-card" *ngIf="stats.daily as dailyStats">
              <h3>Daily Mode</h3>
              <p><strong>Highest Streak:</strong> {{ dailyStats.highestStreak || 0 }} days</p>
              <p><strong>Average Score/Round:</strong> {{ getAverage(dailyStats.totalScore, dailyStats.totalRoundsPlayed) }}</p>
              <p><strong>Average Stars/Round:</strong> {{ getAverage(dailyStats.totalStars, dailyStats.totalRoundsPlayed) }} / 3</p>
            </div>
          </div>
        </div>
        <ng-template #loadingOrNoStats>
          <p>Loading stats or no stats recorded yet. Go play some games!</p>
        </ng-template>
        <div class="modal-footer">
          <a routerLink="/login" class="secondary-action" (click)="showStats = false">Customize Profile</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <app-leaderboard *ngIf="showLeaderboard" (close)="showLeaderboard = false"></app-leaderboard>

  <!-- Stripe Support Link Section -->
  <div class="support-section">
    <a href="https://buy.stripe.com/6oU28kflzfwi9Aw1dufYY00" target="_blank" rel="noopener noreferrer" class="support-link">
      <div class="support-icon">
        <!-- Coffee cup SVG icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
      </div>
      <p class="support-text-desktop">
        Support Better Bible Guesser development today! For the cost of only ONE coffee a month!
      </p>
      <p class="support-text-mobile">
        Support Dev
      </p>
    </a>
  </div>

  <!-- Version and Contact Footer -->
  <footer class="version-footer">
    Version 2.1.1-beta - For any issues/bugs/suggestions, please email bconomy.wiki@gmail.com or join the Discord at <a href="https://discord.gg/XtTbvV2p" target="_blank" rel="noopener noreferrer">https://discord.gg/XtTbvV2p</a>
  </footer>


</div>
