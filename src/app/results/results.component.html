<div class="container">
  <header>
    <h1>Game Over!</h1>
    <p>Here's how you did.</p>
  </header>

  <main>
    <!-- MULTIPLAYER RESULTS -->
    <div *ngIf="lobby">
      <h2>Final Leaderboard</h2>
      <div class="leaderboard-list">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of leaderboard">
              <td>{{ item.rank }}</td>
              <td>{{ item.displayName }} <span *ngIf="item.isHost">(Host)</span></td>
              <td>{{ item.totalScore }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <h2 class="your-results-title">Your Results</h2>
      <div class="total-score">
        <div class="score-breakdown">
          <h3>Total Score: {{ totalScore }} / {{ lobby.gameSettings.rounds * 100 }}</h3>
          <h3>Total Stars: {{ totalStars }} / {{ lobby.gameSettings.rounds * 3 }}</h3>
        </div>
        <div class="copy-results-container">
          <button class="secondary-action" (click)="copyResults()">{{ copyResultsButtonText }}</button>
        </div>
      </div>
      <!-- Re-use the same result card template as single-player -->
      <div *ngFor="let userResult of (multiplayerUserResults$ | async); let i = index" class="result-card" (click)="toggleExpand(i)">
        <div class="result-summary">
          <h3>Round {{ userResult.roundNumber }}</h3>
          <p class="score"><strong>Score:</strong> {{ userResult.score }} / 100</p>
          <div class="stars">
            <span *ngFor="let _ of getStarArray(userResult.stars)" class="star filled">★</span>
            <span *ngFor="let _ of getStarArray(3 - userResult.stars)" class="star">☆</span>
          </div>
          <span class="expand-icon">{{ expandedIndex === i ? '▲' : '▼' }}</span>
        </div>

        <div class="details" *ngIf="expandedIndex === i">
          <p><strong>Correct Verse:</strong> {{ userResult.verse.bookName }} {{ userResult.verse.chapter }}:{{ userResult.verse.verse }}</p>
          <p><strong>Your Guess:</strong>
            <span *ngIf="userResult.guess">{{ userResult.guess.book }} {{ userResult.guess.chapter }}:{{ userResult.guess.verse }}</span>
            <span *ngIf="!userResult.guess">No Guess</span>
          </p>
          <p class="verse-text">"{{ userResult.verse.text }}"</p>
          <div class="indicators">
            <div class="indicator">
              <span class="circle" [class.correct]="userResult.isBookCorrect" [class.incorrect]="!userResult.isBookCorrect"></span>
              <span>Book</span>
            </div>
            <div class="indicator">
              <span class="circle" [class.correct]="userResult.isBookCorrect && userResult.isChapterCorrect" [class.incorrect]="!(userResult.isBookCorrect && userResult.isChapterCorrect)"></span>
              <span>Chapter</span>
            </div>
            <div class="indicator">
              <span class="circle" [class.correct]="userResult.isBookCorrect && userResult.isChapterCorrect && userResult.isVerseCorrect" [class.incorrect]="!(userResult.isBookCorrect && userResult.isChapterCorrect && userResult.isVerseCorrect)"></span>
              <span>Verse</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SINGLE PLAYER RESULTS -->
    <div *ngIf="!lobby && results.length > 0" class="results-list">
      <div class="total-score">
        <div class="score-breakdown">
          <h2>Total Score: {{ totalScore }} / {{ results.length * 100 }}</h2>
          <h2>Total Stars: {{ totalStars }} / {{ results.length * 3 }}</h2>
        </div>
        <div class="copy-results-container">
          <button class="secondary-action" (click)="copyResults()">{{ copyResultsButtonText }}</button>
        </div>
      </div>
      <div *ngFor="let result of results; let i = index" class="result-card" (click)="toggleExpand(i)">
        <div class="result-summary">
          <h3>Round {{ i + 1 }}</h3>
          <p class="score"><strong>Score:</strong> {{ result.score }} / 100</p>
          <div class="stars">
            <span *ngFor="let _ of getStarArray(result.stars)" class="star filled">★</span>
            <span *ngFor="let _ of getStarArray(3 - result.stars)" class="star">☆</span>
          </div>
          <span class="expand-icon">{{ expandedIndex === i ? '▲' : '▼' }}</span>
        </div>

        <div class="details" *ngIf="expandedIndex === i">
          <p><strong>Correct Verse:</strong> {{ result.verse.bookName }} {{ result.verse.chapter }}:{{ result.verse.verse }}</p>
          <p><strong>Your Guess:</strong>
            <span *ngIf="result.guess">{{ result.guess.book }} {{ result.guess.chapter }}:{{ result.guess.verse }}</span>
            <span *ngIf="!result.guess">No Guess</span>
          </p>
          <p class="verse-text">"{{ result.verse.text }}"</p>
          <div class="indicators">
            <div class="indicator">
              <span class="circle" [class.correct]="result.isBookCorrect" [class.incorrect]="!result.isBookCorrect"></span>
              <span>Book</span>
            </div>
            <div class="indicator">
              <span class="circle" [class.correct]="result.isBookCorrect && result.isChapterCorrect" [class.incorrect]="!(result.isBookCorrect && result.isChapterCorrect)"></span>
              <span>Chapter</span>
            </div>
            <div class="indicator">
              <span class="circle" [class.correct]="result.isBookCorrect && result.isChapterCorrect && result.isVerseCorrect" [class.incorrect]="!(result.isBookCorrect && result.isChapterCorrect && result.isVerseCorrect)"></span>
              <span>Verse</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="share-container">
      <h3>Share This Game Challenge</h3>

      <h4>Quick Share (Expires in 30 mins)</h4>
      <p>Give this short code to a friend to play the same game. It's easy to remember but expires in 30 minutes.</p>
      <div class="code-actions">
        <input type="text" [value]="shortShareCode" placeholder="Click 'Create and Copy' to generate" readonly>
        <button (click)="createAndCopyShortCode()" [disabled]="isShortCodeGenerating">{{ shortCodeCopyButtonText }}</button>
      </div>

      <h4 class="permanent-link-title">Permanent Link</h4>
      <p>Use this link to share the game permanently. It won't expire.</p>
      <div class="code-actions">
        <input type="text" [value]="longShareUrl" placeholder="Click 'Copy Link' to generate" readonly>
        <button (click)="createAndCopyPermanentUrl()" [disabled]="isLongCodeGenerating">{{ longCodeCopyButtonText }}</button>
      </div>
    </div>

    <div class="actions">
      <a routerLink="/">Play Again</a>
    </div>
  </main>
</div>
